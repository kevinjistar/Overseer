
---
Version: 1.0.0
Date: 2025-12-09
Changelog:
  - 1.0.0 (2025-12-09): Création du document Contrôle anti dérive / Règles d’arrêt
Breaking Changes: Aucun depuis 1.0.0

Règle de versioning:
  • Major (X.0.0): Modification structurelle des règles d’arrêt ou du protocole de sécurité
  • Minor (1.X.0): Ajout de conditions ou renforcement non disruptif
  • Patch (1.2.X): Ajustements rédactionnels, précisions
---

# Contrôle anti dérive / Règles d’arrêt

Ces règles définissent les mécanismes empêchant l’emballement, la corruption structurelle, les boucles indésirables, ou tout comportement inattendu des agents et du système.  
Elles sont appliquées par l’orchestrateur, Overseer et ValidationAgent.

---

# 1. Principes de sécurité fondamentaux

- Aucune action ne doit continuer en cas d’incohérence structurelle.  
- Aucun agent ne peut déclencher plus d’une mise à jour par cycle tant que la précédente n’est pas validée.  
- Aucune opération ne doit être exécutée sans contexte projet valide.  
- Toute anomalie détectée doit entraîner un arrêt immédiat et un rapport d’erreur.

---

# 2. Conditions d’arrêt immédiat

Le système passe en état `halted` si l’une des conditions suivantes se produit:

## 2.1 Validation documentaire échouée
- schéma non respecté  
- module spécialisé invalide  
- incohérence dans meta ou versioning  
- champ obligatoire manquant  
- contenu non JSON strict  

## 2.2 Boucles d’agents détectées
- deux agents se répondent mutuellement plus d’une fois sans progression  
- un même agent propose plusieurs modifications successives sans changement de contexte  
- même document modifié plus de deux fois en moins de X secondes (paramétrable)

## 2.3 Conflit de versioning
- version reçue inférieure à la version actuelle du document  
- version reçue incompatible avec le type imposé par Overseer  
- meta.ownerAgent incohérent  
- absence de changelog correspondant

## 2.4 Changement de currentProject pendant une opération
- l’utilisateur modifie le projet actif durant une mise à jour  
- un agent renvoie une mise à jour pour un autre projet  
- un agent tente d’accéder à un projet non actif

## 2.5 État de Workflow Engine illégal
- transition non permise par les règles  
- état cible inexistant  
- action invalide ou non définie  

## 2.6 Dépassement de quota interne
- trop de snapshots créés en une seule opération  
- trop de logs générés simultanément  
- surcharge détectée dans les appels agents

---

# 3. Actions en cas d’arrêt

Lors d’un arrêt, l’orchestrateur exécute:

1. suspension immédiate des opérations  
2. restauration du dernier snapshot stable  
3. création d’un log d’erreur:  

systemLogs/errors/{logId}.json

4. envoi d’un rapport à Overseer  
5. réinitialisation des états agentiques liés à l’opération  
6. blocage de toute nouvelle écriture jusqu’à résolution

---

# 4. Détection proactive des dérives

Le système surveille en continu:

- fréquence des mises à jour par agent  
- cohérence globale de la structure Firestore  
- valeurs aberrantes dans les documents  
- répétitions de transitions workflow  
- tailles anormales des documents  
- cycles récurrents detectés via hashing des états  

En cas de suspicion mais pas d’erreur confirmée:
- état `warning`
- ajout d’un log de pré-alerte  
- Overseer en est informé et peut demander une validation approfondie

---

# 5. Règles opérées par Overseer

Overseer doit:

- refuser toute délégation à un agent si un signal `warning` est actif  
- bloquer toute opération tant que le système est en `halted`  
- analyser les logs pour identifier l’origine de la dérive  
- demander explicitement une restauration, une validation ou une reprise  
- empêcher un agent de proposer plusieurs corrections successives sans justification

---

# 6. Règles opérées par ValidationAgent

ValidationAgent doit:

- détecter toute incohérence structurelle  
- vérifier la progression logique entre deux versions  
- garantir la continuité et la cohérence narrative  
- vérifier l’intégrité des liens internes  
- confirmer la compatibilité avec les modules spécialisés  
- renvoyer un verdict strict: `valid` ou `error`

---

# 7. Règles de reprise après arrêt

Pour sortir de l’état `halted`:

1. Overseer doit analyser le rapport d’erreur  
2. Overseer doit demander une validation manuelle du dernier snapshot stable  
3. ValidationAgent doit confirmer la validité  
4. L’orchestrateur doit lever le flag `halted`  
5. Le système reprend en mode `safe`, limitant les agents à une seule action à la fois  
6. Après deux opérations valides successives, retour au mode normal

---

Fin du document Contrôle anti dérive / Règles d’arrêt.
