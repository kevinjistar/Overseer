
---
Version: 1.0.1
Date: 2025-12-09
Changelog:
  - 1.0.1 (2025-12-09): Alignement complet avec la logique de l’orchestrateur, correction des références Firestore, unification avec le Workflow Engine et règles anti-dérive.
  - 1.0.0 (2025-12-09): Création du Pipeline de mise à jour des documents
Breaking Changes: Aucun depuis 1.0.0

Règle de versioning:
  • Major (X.0.0): Modification de la séquence ou de la logique de mise à jour documentaire
  • Minor (1.X.0): Ajout de contrôles supplémentaires ou d’étapes non disruptives
  • Patch (1.2.X): Ajustements rédactionnels ou clarifications
---

# Pipeline de mise à jour des documents

Ce pipeline décrit la procédure officielle et immuable permettant de mettre à jour un document référent via un agent, sous supervision d’Overseer et contrôle technique de l’orchestrateur.  
Aucune action d’écriture ne peut exister en dehors de ce pipeline.

---

# 1. Réception de la requête

Une mise à jour documentaire commence lorsque:
- Overseer transmet une instruction formelle à un agent
- l’agent renvoie un JSON structuré via agentCallback

Le pipeline démarre uniquement si:
- currentProject est défini
- l’agent est autorisé pour ce type de document
- targetDocument est explicitement fourni
- la structure du payload est conforme au schéma d’entrée attendu

---

# 2. Validation initiale de l’agentCallback

L’orchestrateur vérifie:
- identité logique de l’agent émetteur
- cohérence des métadonnées (projectId, documentId, type)
- présence d’un JSON valide (syntaxe)
- présence des champs obligatoires du Schéma universel

En cas d’échec:
- statut error envoyé à Overseer
- aucune modification système
- écriture d’un log d’erreur

---

# 3. Validation structurelle complète

L’orchestrateur appelle validateDocument:

Contrôles réalisés:
- conformité au Schéma universel du Document Référent
- conformité au module spécialisé
- cohérence interne (sections, specialized, narrative, links)
- cohérence inter-documents si des liens sont fournis
- conformité du versioning existant
- présence des champs meta obligatoires
- absence de valeurs hors schéma

Résultat:
- `valid`
- `error` (avec détails de validation)

Aucune mise à jour n’a lieu avant validation complète.

---

# 4. Application stricte du versioning

Si la validation est `valid`, l’orchestrateur applique:

- meta.ownerAgent = agent émetteur  
- meta.updatedAt = date du jour  
- calcul de la version:
  - Major si Overseer l’a imposé
  - Minor si Overseer l’a imposé
  - Patch si modification locale non-structurelle

L’entrée du changelog doit être ajoutée:

“{version} ({date}): {reason}”

Le changelog n’est jamais optionnel.

---

# 5. Préparation de l’écriture contrôlée

L’orchestrateur vérifie:
- que le document appartient bien à currentProject
- que le document n’a pas été modifié depuis la requête (anti-race condition)
- que le document n’est pas en état locked
- que la version entrante est strictement supérieure à la version existante

En cas d’incohérence:
- l’opération est annulée
- Overseer reçoit un statut error
- log système enregistré

---

# 6. Écriture contrôlée du document

L’orchestrateur remplace la version existante du document par la nouvelle version, dans la structure logique Firestore suivante (au moment du déploiement):

projects/{projectId}/documents/{documentId}

Critères d’écriture:
- transaction atomique (pas de moitié d’état)
- écriture uniquement si validation + versioning sont corrects
- aucune tolérance aux écarts de schéma

---

# 7. Création du snapshot versionné

Après écriture réussie, l’orchestrateur génère un snapshot:

snapshots/{projectId}/{snapshotId}/
- document.json
- timestamp
- version
- agent
- reason

Chaque snapshot représente un point stable pour restauration.

---

# 8. Interaction avec le Workflow Engine

Après la mise à jour documentaire:
- l’orchestrateur vérifie les triggers éventuels du Workflow Document
- si une transition est déclenchée:
  - runWorkflowTransition est exécuté immédiatement
- si aucune action de workflow n’est nécessaire:
  - le pipeline continue normalement

Une transition peut:
- déclencher des actions d’agents
- modifier l’état global du projet
- créer un nouveau snapshot

---

# 9. Journalisation complète

L’orchestrateur écrit un log dans:

projects/{projectId}/logs/updates/{logId}.json

Contient:
- id du document modifié
- version finale
- agent responsable
- date
- type de mise à jour
- statut de validation
- transition de workflow éventuelle
- snapshotId généré

Les journaux sont immuables.

---

# 10. Retour final à Overseer

Une réponse formelle est envoyée à Overseer:

- statut: success ou error
- documentId
- version finale
- snapshotId
- transition éventuelle
- résumé synthétique de la mise à jour

Overseer utilise cette réponse pour:
- déclencher d’autres agents
- poursuivre un workflow
- demander une correction
- ou clore proprement la tâche

---

Fin du Pipeline de mise à jour des documents.
