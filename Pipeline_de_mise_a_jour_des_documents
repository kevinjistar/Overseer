---
Document: Pipeline_de_mise_a_jour_des_documents
Version: 2.1.0
Date: 2025-12-17

PolicyVersions:
  ValidationPolicy_Global: 1.0.0
  WorkflowPolicy: 1.0.0
  CorrectionMode_Policy: 1.0.0
  System_Agent_Edit_Policy: 1.0.0
---

# Pipeline de mise à jour des documents

## Objet du document
Ce document définit le processus complet de mise à jour d’un document référent dans Overseer.  
Il décrit, étape par étape, comment une modification passe de l’intention utilisateur à l’écriture finale dans Firestore, avec validation structurelle et sémantique.

## Rôle du document dans le système
Document procédural, il spécifie un pipeline opérationnel de mise à jour documentaire.  
Il décrit le “comment” du flux, sans redéfinir les responsabilités des acteurs.

1. Objet du document

Ce pipeline définit le processus complet de mise à jour d’un document référent dans Overseer.  
Il décrit, étape par étape, comment une modification passe:

• De l’intention utilisateur  
• À la production agentique  
• À la validation structurelle  
• À la validation sémantique (locale + globale)  
• À la décision métier d’Overseer  
• À l’écriture finale dans Firestore  
• Aux transitions workflow structurelles validées  

Ce pipeline garantit:
• absence de dérive,  
• cohérence globale,  
• contrôle absolu de la logique métier,  
• traçabilité totale.


2. Préconditions à toute mise à jour documentaire

2.1 Projet actif  
Un currentProject valide doit être défini.

2.2 État système  
• correctionMode = false  
• halted = false  

2.3 Intégrité précédente  
• snapshot valide disponible  
• absence d’erreurs structurelles actives  

2.4 Chargement des Policies  
Overseer doit charger:
• ValidationPolicy_Global  
• WorkflowPolicy  
• CorrectionMode_Policy  
• System_Agent_Edit_Policy  


3. Étape 1 — Intention utilisateur

L’utilisateur exprime une demande.  
Overseer:
• analyse l’intention,  
• identifie le document concerné,  
• détermine si une mise à jour documentaire est nécessaire,  
• évalue le type de versioning (Major/Minor/Patch),  
• vérifie compatibilité avec les Policies.

Sortie: décision de démarrer le pipeline documentaire.


4. Étape 2 — Préparation du contexte par Overseer

Overseer:
• charge le document original,  
• charge les schémas (universel + specialized),  
• charge System_Agent_Edit_Policy (extrait pertinent),  
• définit operationMode (normal ou correction),  
• génère operationId,  
• assemble une systemInstruction complète.

systemInstruction =  
• document original  
• schémas  
• EditRules  
• Policies actives  
• intention explicite  
• type de versioning imposé  
• operationMode  
• meta opérationnelle  


5. Étape 3 — Appel de l’AgentProducteur

L’orchestrateur reçoit systemInstruction et:
• valide structurellement l’instruction,  
• appelle l’AgentProducteur,  
• reçoit un JSON strict contenant candidateDocument.

Aucun texte libre n’est accepté.  
Un document complet est requis.


6. Étape 4 — Validation structurelle par l’orchestrateur

L’orchestrateur vérifie:
• conformité au Schema_Document_Référent,  
• conformité au module specialized,  
• types et structure valides,  
• absence de champs inconnus,  
• meta conforme,  
• version séquentielle correcte (pas le type métier),  
• JSON strict uniquement.

En cas d’échec → erreur structurelle → pipeline interrompu → retour Overseer.


7. Étape 5 — Validation sémantique locale (obligatoire)

Overseer envoie au SuperiorValidationAgent:
• originalDocument  
• candidateDocument  
• diff  
• projectContext minimal  
• operationMeta  

Le SuperiorValidationAgent retourne un verdict local:

{
  "verdict": "allow | warn | block",
  "reasons": [...],
  "impactedDocuments": [...],
  "workflowImpact": "none | minor | major",
  "riskLevel": "low | medium | high",
  "recommendedFixes": [...]
}

block → Overseer doit corriger ou annuler.  
override possible uniquement en mode normal (marqué comme exception).  
En correctionMode → override interdit.


8. Étape 6 — Validation sémantique globale (si requise)

Selon ValidationPolicy_Global:
• version Major,  
• documents racine,  
• workflowImpact = major,  
• mode correction,  
• risque global élevé,  

→ validation globale OBLIGATOIRE.

SuperiorValidationAgent reçoit un contexte élargi:
• tous les documents du projet,  
• workflowState,  
• Policies,  
• logs récents.

block → correction ou abandon.  
warn → arbitrage Overseer.  
allow → continuer.


9. Étape 7 — Décision finale d’Overseer

Overseer combine:
• validation structurelle,  
• validation locale,  
• validation globale (si effectuée),  
• type de versioning,  
• Policies,  
• état du projet,  
• operationMode.

Décisions possibles:

• apply (appliquer)  
• warn & apply (application avec risque, log obligatoire)  
• correction (nouvelle instruction à un agent correctif)  
• abort (arrêt de l’opération)

En mode correction:
• seules les décisions correction ou abort sont permises si risque élevé.


10. Bloc normatif — CorrectionMode

Ce bloc s’applique lorsque, et seulement lorsque, Overseer active operationMode = "correction".

10.1 Déclencheur
Si verdict = block (local ou global) retourné par SuperiorValidationAgent, Overseer doit exécuter l’une des deux options suivantes, sans exception:
• activer correctionMode et déclencher le chemin correctif décrit ci-dessous,  
• abort explicite de l’opération.

10.2 Chemin correctif obligatoire (si correctionMode activé)
Séquence normative:
1. Overseer active correctionMode.  
2. Overseer construit une instruction de correction minimale à partir des recommendedFixes retournées par SuperiorValidationAgent.  
3. Overseer sélectionne CorrectiveAgent comme unique agent producteur autorisé en correctionMode.  
4. L’orchestrateur appelle CorrectiveAgent.  
5. L’orchestrateur valide structurellement le candidateDocument produit par CorrectiveAgent.  
6. SuperiorValidationAgent valide la correction (locale, puis globale obligatoire).  
7. Overseer décide apply ou reject.  
8. Si apply, l’orchestrateur applique un PATCH uniquement, sans transition workflow, puis log et snapshot si Policy l’exige.  

10.3 Interdictions en correctionMode
• SuperiorValidationAgent ne peut jamais être appelé comme agent producteur.  
• Aucune transition workflow ne peut être exécutée pendant correctionMode.  
• Aucune mise à jour Minor ou Major n’est autorisée, seul PATCH est autorisé.  


11. Étape 8 — Écriture finale par l’orchestrateur

Si Overseer autorise:

L’orchestrateur:
• écrit le document dans Firestore,  
• applique version mécanique (X.Y.Z),  
• met à jour meta.updatedAt,  
• ajoute appliedPolicies,  
• crée snapshot selon Policy,  
• loggue l’événement.

Aucune logique métier n’est exécutée ici.  
L’orchestrateur suit un protocole strictement structurel.


12. Étape 9 — Exécution des transitions workflow structurelles

Après écriture:
• Overseer évalue si une transition métier est pertinente.  
• S’il en décide ainsi, il envoie un ordre `runWorkflowTransition`.

L’orchestrateur:
• vérifie l’existence structurelle de la transition,  
• applique la transition,  
• exécute les actions structurelles,  
• loggue l’état final.

Aucune condition métier n’est évaluée côté orchestrateur.

Interdiction:
• aucune transition workflow ne peut être exécutée si correctionMode = true.


13. Étape 10 — Vérification post-opération par Overseer

Overseer:
• vérifie cohérence globale du projet,  
• détecte contradictions métier,  
• active correctionMode si nécessaire,  
• met à jour son contexte interne,  
• prépare un rapport utilisateur.


14. Résumé du pipeline v2 (essence)

1. Intention utilisateur  
2. Contexte + policies  
3. Instruction agent  
4. Production JSON  
5. Validation structurelle (orchestrateur)  
6. Validation locale (SuperiorValidationAgent)  
7. Validation globale si requise  
8. Décision Overseer  
9. Écriture Firestore + snapshot  
10. Transition workflow structurelle (si ordonnée)  
11. Vérification finale  
12. Rapport utilisateur


15. Invariants du pipeline de mise à jour

Toujours vrais:

• Aucun agent ne modifie Firestore.  
• Aucun agent ne déduit la logique métier.  
• Overseer ne modifie jamais un document lui-même.  
• Orchestrateur n’exécute jamais une transition non ordonnée par Overseer.  
• SuperiorValidationAgent valide toujours la sémantique locale.  
• La validation globale suit strictement ValidationPolicy_Global.  
• Le mode correction désactive toute évolution structurelle non nécessaire.  
• Aucune écriture sans snapshot cohérent.  
• Aucun workflow automatique.  
• Traçabilité complète via operationId et snapshotId.  
• En correctionMode, CorrectiveAgent est l’unique agent autorisé à produire un document candidat de correction.  
• En correctionMode, SuperiorValidationAgent est strictement diagnostiqueur et validateur, jamais producteur.  

Fin du document
---

Document Metadata & Changelog

Changelog:
  - 2.1.0 (2025-12-17): Ajout explicite du chemin CorrectionMode avec CorrectiveAgent (agent producteur unique en correction), normalisation terminologique (ValidationAgent supprimé), clarification des interdictions associées.
  - 2.0.1 (2025-12-14): Normalisation formelle, ajout d’une frontpage standard, déplacement des métadonnées en footer, contenu opérationnel inchangé.
  - 2.0.0 (2025-12-11): Refonte complète intégrant SuperiorValidationAgent, ValidationPolicy_Global, CorrectionMode, Workflow Engine v2 et Processus interne d’appel d’agents v2.
  - 1.0.0 (2025-12-10): Version initiale.

Breaking Changes:
  - Suppression complète de l’ancienne validation unique.
  - Intégration obligatoire de la double validation (structurelle + sémantique locale/globale).
  - Ajout du mode correction et de ses règles restrictives.
  - Abandon de tout déclenchement automatique de workflow.
