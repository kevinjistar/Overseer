---
Document: Gestion_CurrentProject
Version: 1.0.0
Date: 2025-12-20

PolicyVersions:
  ValidationPolicy_Global: 1.0.0
  WorkflowPolicy: 1.0.0
  CorrectionMode_Policy: 1.0.0
  System_Agent_Edit_Policy: 1.0.0
---

# Gestion du currentProject

## 1. Objet du document

Ce document définit les règles normatives de gestion du projet actif (currentProject) utilisé comme contexte unique par:
- Overseer (décision métier et orchestration),
- l’orchestrateur (écritures Firestore et exécutions structurelles),
- les agents (production de JSON strict),
- le workflowEngine (état et transitions structurelles).

Ce document encadre:
- l’emplacement de stockage du currentProject,
- les autorités habilitées à le modifier,
- les conditions de modification,
- les contraintes bloquantes,
- les obligations de journalisation.

Aucune action agentique, aucune mise à jour documentaire, aucune transition de workflowEngine ne peut être engagée sans currentProject valide.

## 2. Définition

Le currentProject correspond à l’identifiant du projet actuellement sélectionné pour un utilisateur donné.

Il est stocké exclusivement dans:
userContext/{userId}/currentProject.json

Le currentProject est un pointeur de contexte:
- il ne contient aucune logique métier,
- il ne contient aucune donnée projet,
- il ne contient aucun historique.

## 3. Responsabilités strictes

### 3.1 Utilisateur
- Peut demander la sélection d’un projectId.
- Peut demander la désactivation du projet actif.

### 3.2 Overseer
- Interprète la demande utilisateur.
- Vérifie les préconditions avant toute écriture.
- Ordonne explicitement à l’orchestrateur une opération de sélection ou de désactivation.
- Refuse toute opération projet si currentProject est absent ou invalide, sauf opérations explicitement hors-projet.
- Injecte le projectId courant dans toute instruction agent et toute opération ordonnée.

### 3.3 Orchestrateur
- Est la seule couche autorisée à écrire userContext/{userId}/currentProject.json.
- Exécute mécaniquement l’ordre d’Overseer, sans interprétation métier.
- Écrit un JSON strict conforme à la structure canonique.
- Journalise chaque changement dans systemLogs/currentProjectSwitch/.

### 3.4 Agents
- Ne lisent jamais Firestore.
- Ne modifient jamais currentProject.
- Ne suggèrent jamais de changement de currentProject dans leurs sorties.

## 4. Structure canonique de currentProject.json

Le document currentProject.json doit respecter exactement la structure suivante:

```json
{
  "projectId": "string|null",
  "selectedAt": "string|null",
  "selectedBy": "string|null",
  "status": "active|none"
}

Contraintes normatives:
• projectId est un identifiant de projet existant lorsque status = “active”.
• projectId vaut null lorsque status = “none”.
• selectedAt est un timestamp ISO 8601 lorsque status = “active”, sinon null.
• selectedBy identifie l’initiateur (userId ou “system”) lorsque status = “active”, sinon null.
• Aucun champ additionnel n’est autorisé.

5. Règles générales

5.1 Existence obligatoire

• Overseer doit exiger un currentProject valide avant toute opération projet.
• Si currentProject.status = “none”, Overseer doit refuser toute opération projet.

5.2 Unicité

• Un seul currentProject est autorisé par userId.
• Aucun état intermédiaire n’est autorisé, la bascule doit être atomique.

5.3 Interdictions

• Aucun agent ne peut initier ou provoquer un changement de currentProject.
• Aucun changement de currentProject ne peut résulter d’une mise à jour documentaire.
• Aucun changement de currentProject ne peut résulter d’une transition de workflowEngine.

6. Sélection d’un projet

6.1 Préconditions de sélection (Overseer)

Overseer doit vérifier:
• projectId fourni et non vide,
• existence de projects/{projectId},
• absence d’opération non clôturée pour ce userId,
• absence d’état halted bloquant la sélection.

6.2 Ordre formel (Overseer vers orchestrateur)

L’ordre doit contenir au minimum:
• userId,
• projectId,
• operationId,
• selectedBy.

6.3 Écriture (orchestrateur)

L’orchestrateur écrit atomiquement:

userContext/{userId}/currentProject.json

avec:
• projectId = valeur demandée,
• selectedAt = timestamp d’écriture,
• selectedBy = valeur transmise,
• status = “active”.

6.4 Post-condition (Overseer)

Overseer doit:
• recharger le contexte projet (documents référents, workflowEngine, meta projet),
• invalider tout cache lié à l’ancien projectId,
• garantir que toute instruction ultérieure référence ce projectId.

7. Remplacement du projet actif

Si currentProject est déjà actif:
• l’orchestrateur remplace intégralement currentProject.json,
• l’ancien projectId est conservé uniquement dans les logs,
• Overseer invalide explicitement son contexte précédent.

8. Désactivation du projet actif

8.1 Préconditions (Overseer)

Overseer doit vérifier:
• absence d’opération critique en cours,
• absence de verrouillage imposé par correctionMode.

8.2 Ordre formel

L’ordre doit contenir:
• userId,
• operationId,
• selectedBy.

8.3 Écriture (orchestrateur)

{
  "projectId": null,
  "selectedAt": null,
  "selectedBy": null,
  "status": "none"
}

8.4 Post-condition (Overseer)

Overseer doit:
• refuser toute opération projet,
• informer l’utilisateur de l’absence de projet actif.

9. Journalisation obligatoire

Chaque changement doit être journalisé dans:
systemLogs/currentProjectSwitch/{logId}.json

Contenu minimal:
• userId,
• previousProjectId (string|null),
• newProjectId (string|null),
• timestamp,
• method (“selection” | “replacement” | “deactivation”),
• operationId.

La journalisation est obligatoire et conditionne la validité de l’opération.

10. Contraintes de cohérence d’exécution

10.1 Agents

• Overseer injecte toujours projectId dans les instructions agents.
• L’orchestrateur refuse un appel agentique si projectId ne correspond pas au currentProject actif.

10.2 Mise à jour documentaire

• Toute mise à jour documentaire doit référencer le projectId du currentProject actif.

10.3 Workflow

• Aucune transition de workflowEngine n’est autorisée si currentProject.status = “none”.

11. Invariants

Toujours vrais:
• currentProject est le contexte unique par userId.
• Seul l’orchestrateur écrit userContext/{userId}/currentProject.json.
• Overseer décide et ordonne, l’orchestrateur exécute.
• Aucun agent ne modifie currentProject.
• Aucune opération projet sans currentProject valide.
• Toute modification est journalisée.

⸻

Fin du document

Document Metadata & Changelog

Changelog:
  - 1.0.0 (2025-12-20) : Initialisation de la version de référence du document.

Breaking Changes:
  - Aucun (baseline pré-système)
