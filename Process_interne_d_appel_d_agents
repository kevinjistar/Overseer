
---
Document: Process_interne_d_appel_d_agents
Version: 2.0.0
Date: 2025-12-10

PolicyVersions:
  ValidationPolicy: 1.0.0
  WorkflowPolicy: 1.0.0
  VersioningPolicy: 1.0.0
  CorrectionPolicy: 1.0.0

Changelog:
  - 2.0.0 (2025-12-10): Mise à jour majeure pour intégrer SuperiorValidationAgent, la double validation sémantique, la System_Agent_Edit_Policy et le mode correction.
  - 1.0.0 (2025-12-10): Version initiale du processus d’appel agentique.

Breaking Changes:
  - L'ancien flux d'appel agentique est remplacé par un pipeline en trois validations (structurelle, sémantique locale, sémantique globale).
  - Introductions du verdict allow/warn/block et du mode correction empêchant les transitions workflow.
---

1. Objet du document

Ce processus décrit la manière dont Overseer prépare, déclenche et supervise l’appel d’un AgentProducteur via l’orchestrateur, ainsi que la manière dont les validations (structurelles et sémantiques) sont réalisées avant toute mise à jour d’un document dans Firestore.

Ce processus s’applique à:
• toutes les modifications documentaires,  
• tous les agents producteurs,  
• tous les projets actifs,  
• tous les modes (normal, correction).


2. Acteurs impliqués

• Overseer  
• AgentProducteur  
• SuperiorValidationAgent  
• Orchestrateur (Cloud Functions)  
• Firestore  


3. Flux général

Le processus interne d’appel d’agents suit ces étapes strictes:

1. Analyse d’Overseer  
2. Préparation de la systemInstruction  
3. Chargement et injection de la System_Agent_Edit_Policy  
4. Appel de l’AgentProducteur via l’orchestrateur  
5. Validation structurelle par l’orchestrateur  
6. Validation sémantique locale par SuperiorValidationAgent  
7. Validation sémantique globale éventuelle (Policy)  
8. Décision finale d’Overseer  
9. Appel écriture orchestrateur ou passage en mode correction  


4. Étape par étape

4.1 Analyse initiale d’Overseer

Overseer:
• détermine le ou les documents impactés,  
• choisit l’AgentProducteur,  
• identifie le type de versioning (Major/Minor/Patch),  
• évalue les impacts métier préliminaires,  
• vérifie les Policies actives,  
• calcule operationMode (normal ou correction).

Sortie: décision d’initier un appel agentique.


4.2 Préparation de la systemInstruction

La systemInstruction construite par Overseer contient:

• document(s) concernés  
• schéma universel + module spécialisé  
• contraintes de versioning  
• Policies actives  
• operationId, projectId  
• operationMode  
• date et contexte du projet  
• intention exacte de la modification  

Cette instruction est structurée et non ambiguë.


4.3 Injection de la System_Agent_Edit_Policy

Avant l’appel, Overseer:
• charge System_Agent_Edit_Policy (version active),  
• sélectionne les règles pertinentes,  
• les ajoute à la systemInstruction sous un bloc “EditRules”.

L’agent ne peut produire que dans ce cadre strict.


4.4 Appel de l’AgentProducteur

L’orchestrateur:
• reçoit la systemInstruction,  
• la valide structurellement,  
• appelle l’AgentProducteur,  
• reçoit un JSON strict contenant candidateDocument.

Tout texte hors JSON est rejeté.


4.5 Validation structurelle par l’orchestrateur

L’orchestrateur valide:
• schéma universel,  
• module spécialisé,  
• JSON strict,  
• absence de clés inconnues,  
• meta correcte,  
• séquence de version (mais pas le type métier),  
• cohérence structurelle minimale.

Si échec → erreur structurelle → retour Overseer → fin du processus.


4.6 Validation sémantique locale par SuperiorValidationAgent

SuperiorValidationAgent reçoit:
• candidateDocument,  
• originalDocument,  
• projectContext,  
• diff,  
• operationMeta.

Il retourne un verdict:

{
  "verdict": "allow | warn | block",
  "reasons": [...],
  "impactedDocuments": [...],
  "workflowImpact": "none | minor | major",
  "riskLevel": "...",
  "recommendedFixes": [...]
}

Cette validation ne modifie rien.


4.7 Validation sémantique globale (selon Policy)

Si la ValidationPolicy l’exige:
• transitions majeures,  
• versions Major,  
• modifications sur documents racine,  
• corrections,

Overseer demande une seconde analyse à SuperiorValidationAgent incluant l’ensemble du projet.

Sortie: verdict global éventuel.


4.8 Décision finale d’Overseer

Overseer combine:
• verdict local,  
• verdict global (si exécuté),  
• intention originale,  
• contraintes de versioning,  
• sensibilité du mode correction.

Décision:

• allow → écriture  
• warn → arbitrage Overseer  
• block → correction ou annulation

En mode correction:
• toute incertitude → block  
• pas de transition workflow  
• corrections minimales uniquement


4.9 Exécution par l’orchestrateur

Si Overseer autorise:

L’orchestrateur:
• écrit le document,  
• applique versioning mécanique,  
• met à jour meta.updatedAt,  
• crée snapshot selon Policy,  
• loggue l’opération,  
• exécute les transitions structurelles du Workflow Engine.

Aucune logique métier n’est évaluée ici.


5. Règles spécifiques

5.1 Interdictions absolues

Un AgentProducteur ne peut jamais:
• modifier l’identité d’un document,  
• décider d’un type de versioning,  
• déclencher un workflow,  
• écrire dans Firestore,  
• court-circuiter SuperiorValidationAgent.

5.2 En mode correction

• un seul agent autorisé,  
• aucune transition workflow,  
• validation globale obligatoire,  
• stabilité prioritaire.


6. Conditions d’arrêt immédiat

Le processus est interrompu si:
• erreur structurelle,  
• JSON invalide,  
• verdict block non overridé,  
• incohérence critique détectée,  
• état halted actif.


7. Invariants

Ce processus garantit:

• séquence déterministe,  
• double validation structurée,  
• séparation stricte métier/structurel,  
• aucune dérive agentique,  
• traçabilité complète,  
• souveraineté d’Overseer,  
• neutralité de l’orchestrateur,  
• cohérence métier assurée par SuperiorValidationAgent.

Fin du document.
