
---
Version: 1.0.1
Date: 2025-12-10
Changelog:
  - 1.0.1 (2025-12-10): Ajout de la section complète 3.9 Retour à l’utilisateur et harmonisation avec l’orchestrateur, correction cohérence globale.
  - 1.0.0 (2025-12-10): Création du document Process interne d’appel d’agents
Breaking Changes: Aucun depuis 1.0.1

Règle de versioning:
  • Major (X.0.0): Modification structurelle du mécanisme d’appel agentique
  • Minor (1.X.0): Ajout ou affinement de comportements sans rupture
  • Patch (1.2.X): Ajustements rédactionnels ou clarifications
---

# Process interne d’appel d’agents

Ce document décrit la séquence normative par laquelle Overseer, l’orchestrateur et les agents interagissent.  
Il garantit un fonctionnement sûr, déterministe et traçable.

---

# 1. Principes généraux

- Overseer est le seul agent autorisé à déléguer une tâche à un agent spécialisé.  
- Les agents ne communiquent jamais entre eux directement.  
- Toute tâche agentique passe par l’orchestrateur.  
- Une tâche ne vise qu’un seul document ou objectif à la fois.  
- Aucune action n’est autorisée sans currentProject actif.  
- L’orchestrateur est responsable de la validation, de l’exécution et du logging.

---

# 2. Flux général d’appel d’un agent

Utilisateur → Overseer → orchestrateur → agent → orchestrateur → Overseer → Utilisateur

Chaque étape est obligatoire et vérifiée.

---

# 3. Étapes détaillées du processus

## 3.1 Analyse par Overseer

Overseer identifie:
- l’objectif demandé  
- le document ou module concerné  
- l’agent approprié  
- le type de version à imposer (Major, Minor, Patch)  
- les contraintes contextuelles  

Overseer génère ensuite une instruction formelle destinée à l’agent.

Structure minimale de l’instruction:

{
  "task": "description précise",
  "targetDocument": "typeDocument",
  "versionType": "Major|Minor|Patch",
  "context": { ... },
  "constraints": { ... }
}

---

## 3.2 Transmission à l’orchestrateur

L’orchestrateur vérifie:
- l’existence d’un currentProject  
- la validité du document ciblé  
- l’autorisation de l’agent  
- la structure correcte de l’instruction  

Si valide, l’orchestrateur prépare l’appel agentique.

---

## 3.3 Appel de l’agent

L’orchestrateur appelle l’agent via GAS, en fournissant:

- le systemPrompt de l’agent  
- l’instruction formelle  
- le document actuel  
- le contexte du projet  
- les modules spécialisés  
- les règles système  

L’agent doit renvoyer un JSON strict:

{
  "updatedDocument": { ... },
  "explanation": "optionnel",
  "agent": "nomAgent"
}

---

## 3.4 Réception via agentCallback

L’orchestrateur vérifie:
- présence de updatedDocument  
- validité JSON  
- identité agent conforme  
- correspondance du targetDocument  
- absence de champs non autorisés  

En cas d’erreur → retour `error` à Overseer.

---

## 3.5 Validation documentaire

Le document proposé passe par validateDocument.

Contrôles:
- conformité Schéma universel  
- conformité module spécialisé  
- cohérence interne  
- versioning requis présent  
- propriétaire correct  
- date correcte  

Si `valid` → suite  
Si `error` → retour Overseer

---

## 3.6 Application de la mise à jour

En cas de validation positive:

- incrémentation de version selon versionType  
- mise à jour meta.updatedAt  
- mise à jour meta.ownerAgent  
- écriture atomique Firestore  
- création snapshot versionné  
- génération log de mise à jour  

---

## 3.7 Post-traitement Workflow Engine

L’orchestrateur vérifie si:
- une transition doit être déclenchée  
- des actions doivent être exécutées  
- un nouvel état doit être appliqué  

Si oui → runWorkflowTransition.

---

## 3.8 Retour à Overseer

Rapport structuré:

{
  "status": "success",
  "document": { ... },
  "version": "x.x.x",
  "snapshotId": "string",
  "workflowTransition": "none|executed",
  "agent": "nomAgent"
}

---

## 3.9 Retour à l’utilisateur

Après réception du rapport de l’orchestrateur, Overseer:

- interprète le résultat  
- détecte les points à signaler  
- prépare un message synthétique  
- résume l’action effectuée ou l’erreur rencontrée  
- informe l’utilisateur du nouvel état  
- liste les prochaines étapes possibles  

Le retour utilisateur inclut:

- agent ayant effectué la tâche  
- document ciblé  
- version appliquée  
- snapshot créé  
- transition éventuelle  
- statut final  
- synthèse claire de la modification  

Overseer est le seul canal de communication entre agents, orchestrateur et utilisateur.

---

# 4. Contraintes strictes

- aucune modification documentaire sans validation orchestrateur  
- aucun agent ne peut appeler un autre agent  
- Overseer doit superviser chaque tâche  
- une seule exécution agentique à la fois par document  
- toute anomalie suit les règles anti dérive  

---

# 5. État du système pendant un appel agentique

Pendant l’exécution:
- le document peut être verrouillé  
- le workflow peut être en état “processing”  
- l’orchestrateur maintient un statut interne  

En cas d’échec ou dépassement de délai → systemRecovery.

---

Fin du document Process interne d’appel d’agents.
