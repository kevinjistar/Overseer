---
Document: Structure_Firestore
Version: 1.0.0
Date: 2025-12-20

PolicyVersions:
  ValidationPolicy_Global: 1.0.0
  WorkflowPolicy: 1.0.0
  CorrectionMode_Policy: 1.0.0
  System_Agent_Edit_Policy: 1.0.0
---

# Structure Firestore

## Objet du document

Ce document définit la structure officielle de stockage Firestore utilisée par le système Overseer.

## Rôle du document dans le système

Niveau: normatif et structurel.
Ce document décrit l’arborescence de stockage, les collections, sous-collections et conventions associées servant de base de persistance pour les projets, documents, workflowEngine, Workflow Documents descriptifs (non exécutifs), logs, snapshots et contextes utilisateurs.
Il constitue une référence obligatoire pour l’orchestrateur et les processus système.
Il ne décrit aucune logique métier, aucun processus opérationnel et aucune règle de validation sémantique.

---

# Structure Firestore

La structure Firestore définie ici constitue la base de stockage du système multi-projets Overseer.
Elle doit être strictement respectée par l’orchestrateur, les agents et les processus internes.

---

# 1. Racines principales

Les collections racines du système sont:

- projects/
- userContext/
- systemLogs/
- systemSettings/

Aucune autre collection racine n’est autorisée.

---

# 2. Collection projects/{projectId}

Chaque projet possède sa propre arborescence interne isolée.

projects/{projectId}/
meta/
project.json
documents/
workflowEngine/
logs/
snapshots/
settings/

---

# 3. Détail des sous-structures

## 3.1 meta/

Contient les métadonnées générales du projet.

Chemin:
projects/{projectId}/meta/project.json

Champs typiques:
- projectId
- name
- createdAt
- createdBy
- status
- description

---

## 3.2 documents/

Contient les documents référents du projet.

projects/{projectId}/documents/
architecture.json
ux.json
strategy.json
workflowDocument.json
notes.json

Chaque document respecte:
- le Schéma universel du Document Référent,
- son module spécialisé associé.

---

## 3.3 workflowEngine/

Contient le Workflow Engine structurel du projet.

Chemin:
projects/{projectId}/workflowEngine/engine.json

Contient:
- états déclaratifs,
- transitions structurelles,
- actions structurelles,
- état initial.

Aucune logique métier n’y est stockée.

---

## 3.4 logs/

Contient l’historique des opérations projet.

Chemins:
projects/{projectId}/logs/
creation.json
updates/{logId}.json
errors/{logId}.json
drift_events/{logId}.json
context_loading/{logId}.json
recovery/{logId}.json
audit_trail/{logId}.json
diffs/{logId}.json

Les logs assurent la traçabilité complète.

Règle structurelle:
Le champ agent est strictement interdit dans tous les logs. Le traçage d’un agent appelé s’effectue uniquement via details.calledAgent.

### 3.4.1 Champs normatifs communs (tous logs projet)

Règles:
- actor désigne exclusivement le composant exécutant techniquement l’action journalisée.
- initiatedBy est obligatoire et vaut un userId (string) ou system.
- actor doit être une valeur de la liste fermée suivante:
  - overseer
  - orchestrator
  - superior_validation_agent
  - corrective_agent
  - context_agent
  - audit_trail_agent
  - system_init
  - sync_agent
- details.calledAgent est optionnel; s’il est présent, il désigne l’agent appelé (enum fermée), et ne modifie jamais actor.

Schéma minimal commun:

{
  "logId": "string",
  "operationId": "string",
  "projectId": "string",
  "timestamp": "string (ISO-8601)",
  "actor": "enum (liste fermée)",
  "initiatedBy": "string (userId) | system",
  "action": "string",
  "details": {
    "calledAgent": "enum | absent"
  }
}

### 3.4.2 logs de mise à jour (updates)

Chemin:
projects/{projectId}/logs/updates/{logId}.json

Champs additionnels typiques:
- targetRef (chemin logique du document impacté)
- changeSummary
- versionBefore
- versionAfter

Note:
- details.calledAgent est présent uniquement si la mise à jour est le résultat direct d’un appel d’agent exécuté par l’orchestrateur.

### 3.4.3 logs d’erreurs (errors)

Chemin:
projects/{projectId}/logs/errors/{logId}.json

Champs additionnels minimaux:
- errorType (StructuralError | SemanticWarn | SemanticBlock | BusinessError | Halted)
- severity (warning | error | halted)
- message

Règles:
- actor = composant ayant émis techniquement l’erreur journalisée.
- si l’erreur survient lors d’un appel d’agent, details.calledAgent doit être renseigné et ne doit pas être porté par actor.

### 3.4.4 logs de dérive (drift_events)

Chemin:
projects/{projectId}/logs/drift_events/{logId}.json

Champs additionnels minimaux:
- driftType
- impactedRefs (array)
- detectionSummary

Règles:
- ces logs décrivent un événement de dérive détecté; ils ne déclenchent aucune action implicite.

### 3.4.5 logs de chargement de contexte (context_loading)

Chemin:
projects/{projectId}/logs/context_loading/{logId}.json

Champs additionnels typiques:
- requestedRefs (array)
- returnedRefs (array)
- bytesReturned

Règles:
- si un AgentTransformateur est appelé pour produire un contexte ou un artefact de contexte, details.calledAgent doit être renseigné.

### 3.4.6 logs de recovery (recovery)

Chemin:
projects/{projectId}/logs/recovery/{logId}.json

Champs additionnels minimaux:
- recoveryPhase (list_snapshots | preview_generated | user_confirmed | executed | blocked)
- snapshotId (string | absent)
- scope (full_project uniquement)
- attemptNumber

Règles:
- la confirmation utilisateur est journalisée avec actor = overseer et initiatedBy = userId.
- l’exécution technique (preview, restauration) est journalisée avec actor = orchestrator et initiatedBy = userId | system.

### 3.4.7 logs audit trail (audit_trail)

Chemin:
projects/{projectId}/logs/audit_trail/{logId}.json

Champs additionnels minimaux:
- auditOperationId
- dateFrom
- dateTo
- maxLogs
- maxOutputBytes

Règles:
- le résultat (timeline) n’est pas persisté.
- l’appel est journalisé avec actor = orchestrator, et details.calledAgent = audit_trail_agent.

### 3.4.8 logs de diffs (diffs)

Chemin:
projects/{projectId}/logs/diffs/{logId}.json

Règles de persistance:
- persister uniquement des métadonnées de diff (diffId, operationId, projectId, timestamp, actor, initiatedBy, summary, references).
- interdiction absolue de persister before et after dans un log ou une trace Firestore.

Note:
- un diff structural peut être généré sans appel d’agent; dans ce cas details.calledAgent est absent.

---

## 3.5 snapshots/

Contient les snapshots permettant le rollback.

projects/{projectId}/snapshots/
initial/
project.json
documents/
workflowEngine/engine.json
versions/
{snapshotId}/
project.json
documents/
workflowEngine/engine.json
timestamp
reason
actor
initiatedBy

Règles:
- actor respecte la liste fermée définie en 3.4.1.
- initiatedBy est obligatoire et vaut un userId (string) ou system.
- le champ agent est interdit.

---

## 3.6 settings/

Contient les paramètres système propres au projet.

---

# 4. Collection userContext/

Stocke le contexte utilisateur, notamment le projet actif.

userContext/{userId}/
currentProject.json

Champs typiques:
- projectId
- selectedAt
- selectedBy
- status

---

# 5. Collection systemLogs/

Journalisation globale du système.

systemLogs/
currentProjectSwitch/{logId}.json
agentActivity/{logId}.json
errors/{logId}.json
sync/{syncId}.json

Règles normatives:
- les champs actor et initiatedBy suivent les mêmes conventions que les logs projet.
- le champ agent est interdit; si un agent est appelé, il est tracé via details.calledAgent.

Schéma minimal commun (systemLogs):

{
  "logId": "string",
  "timestamp": "string (ISO-8601)",
  "actor": "enum (liste fermée, voir 3.4.1)",
  "initiatedBy": "string (userId) | system",
  "action": "string",
  "details": {
    "calledAgent": "enum | absent"
  }
}

Note:
- systemLogs/sync/{syncId}.json trace les opérations de synchronisation externe au niveau système, sans persister de contenus interdits; la persistance de payloads doit respecter les règles de sécurité et de minimisation applicables.

---

# 6. Collection systemSettings/

Configuration interne globale.

systemSettings/
pipelines/
constraints/
versioning.json
agentRules.json
workflowRules.json

---

# 7. Règles structurelles invariantes

Toujours vraies:

- aucune écriture directe hors orchestrateur,
- aucune collection dynamique non déclarée,
- aucun document hors projet pour les documents référents,
- aucune logique métier persistée en base,
- toute écriture liée à un projectId valide,
- toute mutation journalisée.

---
Fin du document
---

Document Metadata & Changelog

Changelog:
  - 1.0.0 (2025-12-20) : Initialisation de la version de référence du document.

Breaking Changes:
  - Aucun (baseline pré-système)
