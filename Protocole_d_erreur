---
Document: Protocole_d_erreur
Version: 1.0.0
Date: 2025-12-20

PolicyVersions:
  ValidationPolicy_Global: 1.0.0
  WorkflowPolicy: 1.0.0
  CorrectionMode_Policy: 1.0.0
  System_Agent_Edit_Policy: 1.0.0
---

1. Objet du document

Ce document définit le protocole normatif de gestion des erreurs dans Overseer, incluant:
- la détection,
- la classification,
- la transmission,
- le traitement,
- la résolution,
- la journalisation.

Le protocole est contractuel: toute divergence d’implémentation ou de process constitue une incohérence bloquante.

2. Acteurs et responsabilités non transférables

2.1 Overseer

Overseer:
- décide du traitement métier,
- interprète et applique les Policies,
- déclenche correctionMode lorsque requis,
- décide d’abort, retry, ou d’entrer en état halted,
- impose l’absence de transition workflow en correctionMode,
- exige la validation sémantique selon ValidationPolicy_Global avant toute écriture validée.

Interdictions:
- Overseer n’exécute pas les écritures Firestore.
- Overseer n’exécute pas de validation structurelle (format, schémas, JSON).

2.2 Orchestrateur

L’orchestrateur:
- appelle les agents,
- valide structurellement les entrées et sorties (JSON strict, schémas, champs, meta attendues),
- exécute les écritures Firestore lorsque et seulement lorsque Overseer l’ordonne,
- exécute le workflowEngine uniquement sur ordre explicite d’Overseer et uniquement hors correctionMode,
- crée snapshots et logs structurels selon les règles applicables.

Interdictions:
- l’orchestrateur n’interprète aucune règle métier,
- l’orchestrateur n’essaie aucune réparation automatique,
- l’orchestrateur ne force pas une transition workflow.

2.3 SuperiorValidationAgent

SuperiorValidationAgent:
- évalue la cohérence sémantique locale et, si demandé, globale,
- retourne un verdict structuré allow, warn, block.

Interdictions:
- il ne modifie aucun document,
- il n’écrit jamais en base,
- il ne déclenche pas de transition workflow,
- il ne décide jamais de l’action finale.

2.4 Agents producteurs

Les agents producteurs:
- produisent un JSON strict conforme au schéma et aux règles injectées,
- ne décident pas, ne valident pas, n’écrivent pas.

Interdictions:
- aucun agent ne déclenche un workflow,
- aucun agent ne modifie Firestore,
- aucun agent ne sort du cadre System_Agent_Edit_Policy.

3. Typologie canonique des états d’erreur

Les états d’erreur autorisés sont exclusivement:
- warning
- error
- halted

Toute autre classification est interdite.

4. Définition normative des catégories d’erreurs

4.1 Erreur structurelle (orchestrateur)

Une erreur structurelle est détectée exclusivement par l’orchestrateur, notamment lorsque:
- JSON invalide, non parseable ou contenant du texte hors JSON attendu,
- non-conformité au schéma universel ou au module spécialisé,
- champs interdits ou clés inattendues,
- meta incohérentes ou champs protégés modifiés,
- séquence de version invalide (format ou séquence mécanique),
- document ou projet introuvable,
- tentative d’écriture lorsque l’état du système est halted,
- tentative d’exécution d’une transition non existante dans le workflowEngine (structurel),
- tentative de transition alors que correctionMode est actif,
- action de transition structurellement invalide,
- violation structurelle de System_Agent_Edit_Policy dans la sortie agent.

Réaction obligatoire:
- arrêt immédiat de l’opération en cours,
- aucune correction automatique,
- émission d’un message d’erreur structuré à destination d’Overseer.

Format minimal attendu (orchestrateur vers Overseer):

{
  "status": "error",
  "errorType": "StructuralError",
  "operationId": "string",
  "projectId": "string",
  "details": "string"
}

4.2 Erreur sémantique (SuperiorValidationAgent)

Une erreur sémantique correspond aux verdicts warn ou block produits par SuperiorValidationAgent.

Conditions typiques (non exhaustives):
- contradiction explicite interne au document candidat,
- contradiction inter-documents détectée sur le contexte projet,
- menace sur un invariant métier ou une stabilité globale,
- workflowImpact = major,
- riskLevel = high,
- incompatibilité sémantique avec les Policies actives.

Format de sortie obligatoire (SuperiorValidationAgent vers Overseer):

{
  "verdict": "warn | block",
  "reasons": ["string"],
  "riskLevel": "low | medium | high",
  "workflowImpact": "none | minor | major",
  "impactedDocuments": ["string"],
  "recommendedFixes": ["string"]
}

Interdictions:
- aucun texte hors JSON,
- aucune décision sur apply, abort ou correction.

4.3 Erreur métier (Overseer)

Une erreur métier est détectée exclusivement par Overseer, notamment lorsque:
- une condition métier indispensable à une transition n’est pas satisfaite,
- une mise à jour est incohérente avec WorkflowPolicy,
- une séquence d’opérations crée une boucle métier,
- une incohérence globale est détectée après une opération (y compris après écriture),
- une décision d’Overseer impose l’arrêt malgré allow (ex: risque systémique non couvert par la validation).

Réaction obligatoire:
- Overseer déclenche correctionMode si une stabilisation est possible,
- Overseer abort si la stabilisation n’est pas possible ou si le risque est trop élevé,
- Overseer peut passer en halted si l’état est jugé critique ou non récupérable par correction contrôlée.

5. Règles opérationnelles de classification

5.1 warning

Définition:
- un risque existe, l’opération peut encore être poursuivie si Overseer l’accepte explicitement.

Règles:
- si warning provient d’un verdict warn, Overseer doit soit apply avec journalisation explicite, soit entrer en correctionMode,
- aucun warning ne doit être “ignoré” sans trace.

5.2 error

Définition:
- l’opération ne peut pas être poursuivie.

Cas minimaux:
- erreur structurelle (orchestrateur),
- verdict block non overridé,
- décision explicite d’Overseer d’arrêter l’opération.

Règles:
- une erreur structurelle arrête immédiatement, sans tentative de réparation,
- un block déclenche correctionMode sauf abort explicite.

5.3 halted

Définition:
- état critique empêchant tout fonctionnement normal.

Conditions typiques (non exhaustives):
- corruption documentaire ou incohérence globale persistante,
- échec de correctionMode (stabilisation impossible),
- répétition d’erreurs structurelles empêchant toute opération fiable,
- violation grave des Policies actives,
- impossibilité de garantir l’intégrité des écritures.

Règles:
- seules les opérations de récupération contrôlée sont autorisées,
- aucune transition workflow n’est autorisée,
- aucune écriture métier n’est autorisée.

6. Protocole séquencé de traitement

6.1 Traitement d’un warning

Séquence obligatoire:
1. Overseer reçoit les signaux (warn de validation, ou warning interne).
2. Overseer décide explicitement:
   - apply, ou
   - correctionMode.
3. Si apply:
   - journalisation obligatoire de la décision et du risque.
4. Si correctionMode:
   - activation immédiate de correctionMode et blocage des transitions workflow.

6.2 Traitement d’une erreur structurelle

Séquence obligatoire:
1. L’orchestrateur stoppe l’opération.
2. L’orchestrateur retourne StructuralError à Overseer.
3. Overseer décide explicitement:
   - abort,
   - retry (exceptionnel, uniquement si cause non systémique),
   - correctionMode (si l’erreur structurelle révèle une incohérence de contenu à stabiliser),
   - passage en halted si répétition ou corruption suspectée.

Interdiction:
- l’orchestrateur ne doit pas transformer une erreur structurelle en correction automatique.

6.3 Traitement d’une erreur sémantique block

Séquence obligatoire:
1. Overseer reçoit verdict block.
2. Overseer active correctionMode par défaut.
3. Overseer ordonne une correction minimaliste via un agent correctif.
4. Validation sémantique locale et globale obligatoire selon ValidationPolicy_Global.
5. Sortie de correctionMode uniquement si stabilité retrouvée et validation globale allow.

6.4 Traitement d’un halted

Séquence obligatoire:
1. arrêt de toutes les opérations non-recovery,
2. récupération contrôlée (systemRecovery) uniquement,
3. après restauration, activation de correctionMode,
4. validation globale obligatoire,
5. reprise des opérations uniquement après décision explicite d’Overseer.

7. correctionMode et erreurs

7.1 Conditions d’entrée en correctionMode

Overseer entre en correctionMode lorsque:
- verdict block est reçu,
- incohérence globale est détectée,
- stabilisation est requise avant toute progression,
- un incident implique un risque de dérive si l’opération continue.

7.2 Contraintes obligatoires en correctionMode

En correctionMode:
- un seul agent correctif autorisé par cycle,
- aucune transition workflow autorisée,
- validation globale obligatoire avant sortie,
- modifications minimales et ciblées,
- toute incertitude doit conduire à block ou abort, jamais à apply silencieux.

7.3 Conditions de sortie de correctionMode

Overseer ne peut sortir de correctionMode que si:
- la validation globale retourne allow,
- Overseer confirme explicitement la sortie,
- le système est jugé stable et cohérent.

8. systemRecovery

8.1 Définition

systemRecovery est le protocole contrôlé de restauration d’un état cohérent à partir de snapshots et de logs, exécuté par l’orchestrateur sur ordre d’Overseer.

8.2 Séquence minimale

1. Overseer décide systemRecovery et fournit operationMeta.
2. L’orchestrateur restaure depuis snapshot sélectionné.
3. L’orchestrateur journalise l’opération de restauration.
4. L’orchestrateur force l’état correctionMode actif.
5. Overseer exécute une validation globale via SuperiorValidationAgent.
6. Overseer décide reprise ou maintien en halted.

Interdictions:
- aucune restauration ne doit être silencieuse,
- aucune restauration ne doit réactiver un workflow automatiquement.

8.3 Erreurs en systemRecovery

Règle normative:
• Toute erreur ou déviation en systemRecovery est traitée conformément à Process_systemRecovery.
• Le protocole Process_systemRecovery est la référence unique pour le RecoveryPreview, la confirmation utilisateur via Overseer, et la restauration atomique fullProject.

Limite stricte:
• systemRecovery: 3 tentatives consécutives maximum.
• au-delà, blocage manuel requis.

9. Sync externe

9.1 Règle de protection sur rejets consécutifs

Règle normative:
• En cas de 3 rejets consécutifs de synchronisation externe, la synchronisation externe du projet doit être désactivée temporairement pendant 1h.
• Ce dépassement constitue un état de protection, pas un état halted.
• L’état global du projet reste active (sauf décision explicite indépendante d’Overseer de passer en halted pour d’autres raisons).

9.2 Journalisation du dépassement

Règle normative:
• Le dépassement (3 rejets consécutifs) DOIT être journalisé.
• La journalisation doit expliciter qu’il s’agit d’une désactivation temporaire de 1h et d’un état de protection, pas d’un halted.

10. Journalisation des erreurs

10.1 Nomenclature officielle des acteurs (liste exhaustive et fermée)

Les seuls acteurs reconnus pour la journalisation sont:
- overseer
- orchestrator
- superiorValidationAgent
- correctiveAgent
- contextAgent
- auditTrailAgent
- systemInit
- syncAgent

Règle structurelle (enforcement):
Tout log contenant un actor hors de cette liste DOIT être rejeté structurellement par l'orchestrateur avec erreur InvalidActor.

Aucun autre actor n'est autorisé.
Aucune extension implicite n'est permise.

10.2 Champs logs et snapshots, normalisation initiatedBy

Interdictions:
• Le champ agent est interdit dans tout log et tout snapshot.
• Tout payload log ou snapshot contenant agent DOIT être rejeté structurellement par l’orchestrateur (erreur: ForbiddenField).

Règles normatives:
• initiatedBy est obligatoire dans tout log et tout snapshot.
• initiatedBy est un string, contenant un userId ou la valeur "system".
• actor respecte strictement l’enum fermée définie en 10.1.

10.3 Compatibilité rétroactive (mapping localisé, unique)

Règles normatives:
• Toute occurrence de ValidationAgent est considérée obsolète.
• Le mapping officiel et unique est: ValidationAgent → superiorValidationAgent (champ actor uniquement).
• Toute migration DOIT créer les champs:
  • migrated: true
  • migrationDate: <timestamp>

10.4 Emplacement et schéma minimal

Toute erreur doit être journalisée dans:

logs/{projectId}/errors

Chaque entrée contient au minimum:
- timestamp,
- operationId,
- projectId,
- errorType (StructuralError | SemanticWarn | SemanticBlock | BusinessError | Halted),
- severity (warning | error | halted),
- actor (overseer | orchestrator | superiorValidationAgent | correctiveAgent | contextAgent | auditTrailAgent | systemInit | syncAgent),
- initiatedBy (userId | "system"),
- details,
- stateBefore,
- stateAfter,
- policiesActives (versions effectives).

10.5 Exemple unique (log et snapshot conformes)

Exemple de log conforme (logs/{projectId}/errors/{errorId}.json):

{
  "timestamp": "2025-12-20T10:15:30Z",
  "operationId": "op_123",
  "projectId": "proj_456",
  "errorType": "StructuralError",
  "severity": "error",
  "actor": "orchestrator",
  "initiatedBy": "system",
  "details": "InvalidActor: actor=unknownAgent",
  "stateBefore": { "mode": "normal" },
  "stateAfter": { "mode": "normal" },
  "policiesActives": {
    "ValidationPolicy_Global": "1.0.0",
    "WorkflowPolicy": "1.0.0",
    "CorrectionMode_Policy": "1.0.0",
    "System_Agent_Edit_Policy": "1.0.0"
  }
}

Exemple de snapshot conforme (snapshots/{projectId}/{snapshotId}.json):

{
  "timestamp": "2025-12-20T10:16:05Z",
  "snapshotId": "snap_001",
  "operationId": "op_123",
  "projectId": "proj_456",
  "actor": "orchestrator",
  "initiatedBy": "system",
  "scope": "fullProject",
  "storageRef": "projects/proj_456/snapshots/snap_001",
  "reason": "systemRecoveryPreview"
}

11. Invariants du protocole d’erreur

Toujours vrais:

- L’orchestrateur ne raisonne jamais sur le métier.
- SuperiorValidationAgent ne modifie jamais Firestore.
- Overseer est souverain pour les erreurs métier.
- Aucune réparation automatique côté orchestrateur.
- Une erreur structurelle arrête immédiatement l’opération en cours.
- Une erreur sémantique block déclenche correctionMode.
- halted ne peut être levé que par recovery contrôlée.
- Aucune transition workflow ne peut être déclenchée en présence d’une erreur métier ou structurelle.
- correctionMode est l’unique voie de stabilisation avant halted métier.

---
Fin du document
---
Document Metadata & Changelog

Changelog:
  - 1.0.0 (2025-12-20) : Initialisation de la version de référence du document.

Breaking Changes:
  - Aucun (baseline pré-système)
