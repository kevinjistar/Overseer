
---
Version: 1.1.0
Date: 2025-12-10
Changelog:
  - 1.1.0 (2025-12-10): Mise à jour du Schéma Workflow Engine, ajout compatibilité ProjectSchema 1.1.0, Sync, Overseer, règles anti-boucle, validation renforcée
  - 1.0.0 (2025-12-10): Initialisation du Schéma Workflow Engine
Breaking Changes: Aucun depuis 1.0.0

Règle de versioning:
  • Major (X.0.0): Révision fondamentale de la logique d’exécution ou de la représentation des états
  • Minor (1.X.0): Ajout de nouvelles capacités dans les workflows (ex: nouveaux types de triggers ou d’actions)
  • Patch (1.2.X): Corrections internes sans changement structurel
---

# 1. Description conceptuelle

Le Workflow Engine est un système déterministe de gestion d’états.  
Un workflow évolue selon une logique stricte:

1. Un état initial est défini.  
2. Un événement, une demande ou un changement documentaire propose une transition.  
3. Les conditions sont vérifiées par l’orchestrateur.  
4. Si elles sont satisfaites, la transition est effectuée.  
5. Des actions peuvent être exécutées.  
6. Les agents peuvent être sollicités pour analyser, produire ou modifier des documents.  
7. Overseer vérifie la cohérence, la conformité aux schémas et le versioning.  
8. Toute erreur déclenche la gestion d’erreurs interne.

Objectifs du Workflow Engine:
- éviter les boucles  
- empêcher les transitions invalides  
- garantir cohérence et traçabilité  
- permettre automatisation contrôlée et transparente  
- s’intégrer directement avec ProjectSchema et Overseer  

---

# 2. Schéma JSON complet — WorkflowEngineSchema (Version 1.1.0)

{
  "title": "WorkflowEngineSchema",
  "type": "object",
  "required": ["meta", "states", "transitions", "initialState"],
  "properties": {

    "meta": {
      "type": "object",
      "required": ["id", "name", "projectId", "createdAt"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "projectId": { "type": "string" },
        "description": { "type": "string" },
        "createdAt": { "type": "string" },
        "updatedAt": { "type": "string" },
        "version": { "type": "string" }
      }
    },

    "initialState": {
      "type": "string",
      "description": "État à partir duquel le workflow démarre"
    },

    "states": {
      "type": "array",
      "description": "Liste des états possibles",
      "items": {
        "type": "object",
        "required": ["id", "label"],
        "properties": {
          "id": { "type": "string" },
          "label": { "type": "string" },
          "description": { "type": "string" },
          "onEnter": {
            "type": "array",
            "items": { "$ref": "#/definitions/Action" }
          },
          "onExit": {
            "type": "array",
            "items": { "$ref": "#/definitions/Action" }
          }
        }
      }
    },

    "transitions": {
      "type": "array",
      "description": "Décrit comment on passe d’un état à un autre",
      "items": {
        "type": "object",
        "required": ["from", "to"],
        "properties": {
          "from": { "type": "string" },
          "to": { "type": "string" },

          "conditions": {
            "type": "array",
            "items": { "$ref": "#/definitions/Condition" }
          },

          "actions": {
            "type": "array",
            "items": { "$ref": "#/definitions/Action" }
          },

          "agentsInvolved": {
            "type": "array",
            "items": { "type": "string" }
          },

          "notes": {
            "type": "string",
            "description": "Optionnel, permet de contextualiser la transition"
          }
        }
      }
    },

    "errorHandling": {
      "type": "object",
      "properties": {
        "onInvalidTransition": { "type": "string" },
        "onFailedCondition": { "type": "string" },
        "onAgentError": { "type": "string" },
        "onLoopDetected": { "type": "string" }
      }
    }
  },

  "definitions": {
    "Condition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { 
          "type": "string",
          "enum": [
            "fieldEquals",
            "fieldNotEquals",
            "flagSet",
            "documentExists",
            "custom",
            "workflowState",
            "projectConstraint",
            "versionCompare"
          ]
        },
        "value": { "type": "string" },
        "parameters": {
          "type": "object"
        }
      }
    },

    "Action": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "callAgent",
            "updateDocument",
            "setFlag",
            "logEvent",
            "emitSyncEvent",
            "enqueueOperation",
            "custom"
          ]
        },
        "agent": { "type": "string" },
        "task": { "type": "string" },
        "parameters": {
          "type": "object"
        }
      }
    }
  }
}

---

# 3. Cohérence globale

Ce schéma WorkflowEngine 1.1.0 est désormais:

- compatible avec ProjectSchema 1.1.0 (sections workflow, activeWorkflow, logs)  
- compatible avec Overseer (contrôle versioning, transitions, erreurs)  
- compatible avec le pipeline Sync (emitSyncEvent)  
- compatible avec l’orchestrateur (enqueueOperation, callAgent)  
- compatible avec Document Référent (conditions documentExists, versionCompare)  
- protégé contre les boucles (onLoopDetected)  
- extensible sans rupture (actions custom, conditions custom)  

Fin de la mise à jour.
